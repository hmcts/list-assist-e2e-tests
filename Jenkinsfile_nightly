#!groovy
properties([
  pipelineTriggers([cron('H 8 * * 1-5')]),
  disableConcurrentBuilds(),
  parameters([
    string(
      name: 'FUNCTIONAL_TESTS_WORKERS',
      defaultValue: '4',
      description: 'Number of workers running functional tests'
    ),
    string(
      name: 'TAGS_TO_RUN',
      defaultValue: '',
      description: 'Optionally, run a single or multiple tags (comma separated e.g. @cui, @exui)'
    ),
    choice(
      name: 'browser',
      choices: ['chrome', 'firefox', 'webkit', 'edge'],
      description: 'Which browser to use'
    ),
    choice(
      name: 'TEST_SUITE',
      choices: ['bvt', 'regression', 'bvt_and_regression'],
      description: 'Select which test suite(s) to run',
      defaultValue: 'bvt'
    ),
  ])
])

@Library("Infrastructure")

def type = "nodejs"
def product = "snl-automation"
def component = "e2e-tests"
def channel = "#list-assist-qa-builds"

static Map<String, Object> secret(String secretName, String envVariable) {
  [
    $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    envVariable: envVariable
  ]
}

def secrets = [
  'snl-automation-bts-stg': [
    secret('test-password', 'TEST_USERNAME'),
    secret('test-username', 'TEST_PASSWORD'),
    secret('base-url', 'BASE_URL'),
    secret('hmi-client-id', 'HMI_CLIENT_ID'),
    secret('hmi-client-secret', 'HMI_CLIENT_SECRET'),
    secret('hmi-scope', 'HMI_SCOPE'),
    secret('hmi-token-url', 'HMI_TOKEN_URL'),
    secret('hmi-token-tenant', 'HMI_TOKEN_TENANT'),
    secret('hmi-grant-type', 'HMI_GRANT_TYPE'),
    secret('hmi-api-url', 'HMI_API_URL'),
  ]
]

def buildPlaywrightCommand(tags) {
  if (tags == null || tags.trim().isEmpty()) {
    return;
  }
  def tagList = tags.split(',').collect { it.trim() }
  def command = 'playwright test'
  tagList.each { tag ->
    if (!tag.isEmpty()) {
      command += " --grep ${tag} --project ${params.browser}"
    }
  }
  return command
}

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

def runPlaywrightStage(stageName, command, reportName, skipCreateCase = null) {
  stage(stageName) {
    try {
      if (skipCreateCase != null) {
        env.SKIP_CREATE_CASE = skipCreateCase
      }
      yarnBuilder.yarn(command)
    } catch (Error) {
      unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
    } finally {
      publishHTML([
        allowMissing: true,
        alwaysLinkToLastBuild: true,
        keepAll: true,
        reportDir: "playwright-report",
        reportFiles: 'index.html',
        reportName: reportName
      ])
      if (skipCreateCase != null) {
        env.SKIP_CREATE_CASE = null
      }
    }
  }
}

def bvtStages = [
  [name: 'Chrome - Add Participant Tests', command: 'playwright test --project=chrome --grep @add-participant'],
  [name: 'Chrome - Case Creation Tests', command: 'playwright test --project=chrome --grep @add-new-case'],
  [name: 'Chrome - Case Listing and Reporting Tests', command: 'playwright test --project=chrome --grep @case-listing-and-reporting'],
  [name: 'Chrome - Hearing Channel Tests', command: 'playwright test --project=chrome --grep @hearing-channel'],
  [name: 'Chrome - UI Tests', command: 'playwright test --project=chrome --grep @ui-test'],
  [name: 'Chrome - Amend Api Tests before listing', command: 'playwright test --project=chrome --grep @amend-api-test', skip: 'true'],
  [name: 'Chrome - Amend Api test after listing', command: 'playwright test --project=chrome --grep @amend-api-test-after-listing', skip: 'true'],
  [name: 'Chrome - Add new user test', command: 'playwright test --project=chrome --grep @add-user', skip: 'true'],
  [name: 'Chrome - Daily cause reports test', command: 'playwright test --project=chrome --grep @daily-cause-list-tests'],
  [name: 'Firefox - Add new user test', command: 'playwright test --project=firefox --grep @add-user', skip: 'true'],
  [name: 'Firefox - Add Participant Tests', command: 'playwright test --project=firefox --grep @add-participant'],
  [name: 'Firefox - Case Creation Tests', command: 'playwright test --project=firefox --grep @add-new-case'],
  [name: 'Firefox - Case Listing and Reporting Tests', command: 'playwright test --project=firefox --grep @case-listing-and-reporting'],
  [name: 'Firefox - Hearing Channel Tests', command: 'playwright test --project=firefox --grep @hearing-channel'],
  [name: 'Firefox - Daily cause reports test', command: 'playwright test --project=firefox --grep @daily-cause-list-tests'],
  [name: 'Firefox - UI Tests', command: 'playwright test --project=firefox --grep @ui-test'],
  [name: 'Webkit - Smoke Tests', command: 'playwright test --project=webkit --grep @smoke']
]

def runBvtStages() {
  bvtStages.each { s ->
    runPlaywrightStage(s.name, s.command, s.name, s.skip ?: null)
  }
}

def runRegressionStage() {
  runPlaywrightStage('Regression Suite', 'playwright test regression', 'Regression Suite')
}

withNightlyPipeline(type, product, component, 600) {
  loadVaultSecrets(secrets)
  env.CITIZEN_FRONTEND_BASE_URL = params.CITIZEN_FRONTEND_BASE_URL
  env.MANAGE_CASES_BASE_URL = params.MANAGE_CASES_BASE_URL
  env.FUNCTIONAL_TESTS_WORKERS = params.FUNCTIONAL_TESTS_WORKERS
  enableSlackNotifications(channel)

  afterAlways('DependencyCheckNightly') {
    stage('Check For UK Bank Holiday') {
      script {
        def today = new Date().format('yyyy-MM-dd', TimeZone.getTimeZone('Europe/London'))
        def holidays = sh(
          script: "jq -r '.\"england-and-wales\".events[].date' bank-holidays.json",
          returnStdout: true
        ).trim().split('\n')
        if (holidays.contains(today)) {
          echo "Today (${today}) is a UK bank holiday. Skipping build."
          currentBuild.result = 'NOT_BUILT'
          error("Bank holiday - aborting build")
        }
      }
    }
    stage('Set up playwright') {
      try {
        yarnBuilder.yarn('setup')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }

    if (params.TAGS_TO_RUN && !params.TAGS_TO_RUN.isEmpty()) {
      stage("${params.TAGS_TO_RUN} E2E Tests ${params.browser}") {
        try {
          currentBuild.displayName = "${params.TAGS_TO_RUN} E2E Tests"
          yarnBuilder.yarn(buildPlaywrightCommand(params.TAGS_TO_RUN))
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "playwright-report",
            reportFiles: 'index.html',
            reportName: "${params.TAGS_TO_RUN} E2E Tests ${params.browser}"
          ])
        }
      }
    } else {
      if (params.TEST_SUITE == 'bvt') {
        runBvtStages()
      }
      if (params.TEST_SUITE == 'regression') {
        runRegressionStage()
      }
      if (params.TEST_SUITE == 'bvt_and_regression') {
        runBvtStages()
        runRegressionStage()
      }
    }
  }
}
